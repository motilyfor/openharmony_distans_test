"use strict";var __importDefault=this&&this.__importDefault||function(t){return t&&t.__esModule?t:{default:t}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.AbstractLocalComponentLoader=void 0;const Utils_1=require("../util/Utils"),OhComponentConstants_1=require("../../ohos/const/OhComponentConstants"),path_1=__importDefault(require("path")),fs_1=__importDefault(require("fs")),ComponentDto_1=require("./ComponentDto"),SimpleLogger_1=__importDefault(require("../log/SimpleLogger")),ComponentContants_1=require("../constants/ComponentContants");class AbstractLocalComponentLoader{constructor(t,e,o=new SimpleLogger_1.default){this._TEMP_PREFIX=[".temp",".delete"],this._maxScanDepth=t,this.sdkRoot=e,this.logger=o}load(){const t=this.findPotentialSdks(this.sdkRoot);return this.parseSdks(t)}parseSdks(t){const e=new Map;for(const o of t)try{const t=fs_1.default.readFileSync(o,{encoding:"utf-8"}),n=JSON.parse(t),s=this.convertComponent(n);if(!this.isValidComponent(s))continue;if(!this.isComponentInRightPlace(s,o)){this.logger.debug(`Component ${s.getDisplayName()}:${s.getVersion()} has been placed in the wrong place, expect ${s.getLocation()}, actual ${path_1.default.resolve(o,"..")}`);continue}this.addToMap(e,s)}catch(t){this.logger.warn("Failed to get uni-package Info")}const o=[];return e.forEach((t=>o.push(t))),o}convertComponent(t){const e=new ComponentDto_1.ComponentDto;e.path=t.path,e.version=t.version,e.releaseType=t.releaseType,e.displayName=t.displayName;const o=Number(t.apiVersion);return Number.isNaN(o)||(e.apiVersion=o),e.location=this.getLocation(e,this.sdkRoot),this.configMeta(t,e),e}isComponentInRightPlace(t,e){return t.getLocation()===path_1.default.resolve(e,"..")}addToMap(t,e){let o;o=e.hasApiVersion()?e.getPath()+"#"+e.getApiVersion():e.getPath();const n=t.get(o);(null==n||n.compareTo(e)<0)&&t.set(o,e)}findPotentialSdks(t){const e=[];if(null==t)return e;const o=(0,Utils_1.fsStateSync)(t);if(void 0===o||!o.isDirectory())return e;if(!this._needScan(path_1.default.basename(t)))return e;const n=new Map,s=[];for(s.push(t),n.set(t,1);0!==s.length;){const t=s.pop(),o=n.get(t);if(!(o>this._maxScanDepth)&&this._needScan(path_1.default.basename(t)))for(let i of fs_1.default.readdirSync(t)){i=path_1.default.resolve(t,i);const a=path_1.default.resolve(i,this.getUniPackageName()),r=(0,Utils_1.fsStateSync)(a);if(void 0!==r&&r.isFile()){e.push(a);continue}const l=(0,Utils_1.fsStateSync)(i);void 0!==l&&l.isDirectory()&&this._needScan(path_1.default.basename(i))&&(s.push(i),n.set(i,o+1))}}return e}_needScan(t){for(const e of this._TEMP_PREFIX)if(t.startsWith(e))return!1;return!0}isValidComponent(t){return(0,Utils_1.isEmpty)(t.getPath())?(this.logger.warn("path is empty"),!1):(0,Utils_1.isEmpty)(t.getDisplayName())?(this.logger.warn("displayName is empty"),!1):(0,Utils_1.isEmpty)(t.getVersion())?(this.logger.warn("version is empty"),!1):ComponentContants_1.VERSION_PATTERN.test(t.getVersion())?void 0===t.getApiVersion()||t.getApiVersion()<0?(this.logger.warn(`Illegal component ${t.getDisplayName()}:${t.getVersion()}, apiVersion should not be less than 0`),!1):(0,Utils_1.isEmpty)(t.getLocation())?(this.logger.warn(`Illegal component ${t.getDisplayName()}:${t.getVersion()}, location is null`),!1):!!this._isValidMetaVersion(t):(this.logger.warn(`Illegal component ${t.getDisplayName()}:${t.getVersion()}, version is incorrect`),!1)}_isValidMetaVersion(t){var e;const o=null===(e=t.getMeta())||void 0===e?void 0:e.getMetaVersion();return!(0,Utils_1.isEmpty)(o)&&(ComponentContants_1.META_VERSION_PATTERN.test(o)?0==(0,Utils_1.compareVersion)(o,OhComponentConstants_1.SUPPORT_META_VERSION):(this.logger.warn(`Illegal component ${t.getDisplayName()}:${t.getVersion()}, Incorrect meta version ${o}`),!1))}getLocation(t,e){const o=t.getPath();if(!(0,Utils_1.isEmpty)(o))return t.hasApiVersion()?o.startsWith(OhComponentConstants_1.IMAGE_PATH_PREFIX)?path_1.default.resolve(e,this.resolveComponentPath(o),t.getApiVersion()+""):path_1.default.resolve(e,this.resolveComponentPath(o),t.getVersion()):path_1.default.resolve(e,this.resolveComponentPath(o))}resolveComponentPath(t){return t.replace(",",path_1.default.sep)}}exports.AbstractLocalComponentLoader=AbstractLocalComponentLoader;