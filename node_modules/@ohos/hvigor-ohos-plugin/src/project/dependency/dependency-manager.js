"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.DependencyManager=void 0;const path_1=__importDefault(require("path")),fs_extra_1=__importDefault(require("fs-extra")),resolve_package_path_1=__importDefault(require("resolve-package-path")),common_const_js_1=require("../../const/common-const.js"),error_url_js_1=require("../../utils/error-url.js"),project_file_reader_js_1=require("../../utils/project-file-reader.js"),module_type_enum_js_1=require("../../enum/module-type-enum.js"),ohos_logger_js_1=require("../../utils/log/ohos-logger.js"),module_dependency_info_js_1=require("./module-dependency-info.js"),default_npm_dependency_js_1=require("./core/default-npm-dependency.js"),default_module_dependency_js_1=require("./core/default-module-dependency.js"),log=ohos_logger_js_1.OhosLogger.getLogger("ohos-dependency-manager"),solution=`Using OpenHarmony npm packages or modules that are compatible with current module. Check the OpenHarmony npm package or module below. To understand more about Stage and FA model, please read:${error_url_js_1.ErrorUrl.ERROR_URL.modelDiff}`;class DependencyManager{constructor(e,o,t){this._log=ohos_logger_js_1.OhosLogger.getLogger(DependencyManager.name),this._allDependencySet=new Set,this._isFaMode=e,this._model=o,this._moduleName=o.getName(),this._projectModel=t}createModelDependencyInfo(){this._allDependencySet.clear();const e=this._model.getPackageJsonPath(),o=[],t=new Map;if(this.collectHarDependency(e,t,o),this._projectModel){const e=this._projectModel.getPackageJsonPath();this.collectHarDependency(e,t,o)}return this._log.debug(`Module ${this._moduleName} Collected Dependency: ${o.map((e=>e.getDependencyRootPath()))}`),new module_dependency_info_js_1.ModuleDependencyInfo(t,o)}collectHarDependency(e,o,t){const n=[e];for(;n.length>0;){const e=n.shift(),r=path_1.default.dirname(e),s=fs_extra_1.default.readJsonSync(e,{throws:!1});for(const e in null==s?void 0:s.dependencies)if(Object.prototype.hasOwnProperty.call(null==s?void 0:s.dependencies,e)){const s=(0,resolve_package_path_1.default)(e,r);if(null===s)continue;const a=fs_extra_1.default.readJsonSync(s,{throws:!1}),l=a.name,d=path_1.default.dirname(s);if(!this.isValidHar(d))continue;if(!a.ohos)continue;if(this._allDependencySet.has(l))continue;this._allDependencySet.add(l),this._model.getAllModules().forEach((t=>{if(t.getProjectDir()===d){const n=new default_module_dependency_js_1.DefaultModuleDependency(t.getName(),t.getProjectDir(),e,s,l);o.set(t.getName(),n)}})),t.push(new default_npm_dependency_js_1.DefaultNpmDependency(e,d,s,l)),n.push(s)}}}isValidHar(e){const o=path_1.default.resolve(e,"src","main",common_const_js_1.CommonConst.MODULE_JSON5),t=path_1.default.resolve(e,"src","main",common_const_js_1.CommonConst.MODULE_JSON),n=path_1.default.resolve(e,"src","main",common_const_js_1.CommonConst.CONFIG_JSON);return this.checkHarStatus(o,!1)||this.checkHarStatus(t,!1)||this.checkHarStatus(n,!0)}checkHarStatus(e,o){var t,n,r;if(!fs_extra_1.default.existsSync(e))return!1;const s=project_file_reader_js_1.ProjectFileReader.getJson5Obj(e),a=(null===(t=s.module)||void 0===t?void 0:t.type)===module_type_enum_js_1.ModuleType.Har||(null===(r=null===(n=s.module)||void 0===n?void 0:n.distro)||void 0===r?void 0:r.moduleType)===module_type_enum_js_1.ModuleType.Har,l=this._isFaMode?"FA model":"Stage model",d=this._isFaMode?"Stage model":"FA model";return a&&this._isFaMode!==o&&log._buildError(`${l} module ${this._moduleName} does not support including OpenHarmony npm packages or modules in ${d}. OpenHarmony build tasks will not be executed, and OpenHarmony resources will not be packed.`)._solution(solution)._file(e)._printErrorAndExit(this._moduleName),a}}exports.DependencyManager=DependencyManager;