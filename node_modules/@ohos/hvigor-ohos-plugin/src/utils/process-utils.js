"use strict";var __createBinding=this&&this.__createBinding||(Object.create?function(e,t,o,r){void 0===r&&(r=o);var s=Object.getOwnPropertyDescriptor(t,o);s&&!("get"in s?!t.__esModule:s.writable||s.configurable)||(s={enumerable:!0,get:function(){return t[o]}}),Object.defineProperty(e,r,s)}:function(e,t,o,r){void 0===r&&(r=o),e[r]=t[o]}),__setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),__importStar=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var o in e)"default"!==o&&Object.prototype.hasOwnProperty.call(e,o)&&__createBinding(t,e,o);return __setModuleDefault(t,e),t},__importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.ProcessUtils=void 0;const execa_1=__importDefault(require("execa")),path_1=__importDefault(require("path")),ohos_logger_1=require("./log/ohos-logger"),iconv=__importStar(require("iconv-lite")),system_util_js_1=require("./system-util.js"),fs_1=__importDefault(require("fs")),os=__importStar(require("os"));class ProcessUtils{constructor(e="root",t,o="Tools execution failed.",r="Please check the message from tools.",s="utf-8"){this._log=ohos_logger_1.OhosLogger.getLogger(ProcessUtils.name),this._defaultOptions={encoding:null},this._moduleName=e,this._taskName=t,this._errlog=o,this._solution=r,this._ohosCharset=s}executeSync(e,t,o=!1){var r,s,i;const l=this.processOptionsFactory(t);let _;try{this.validateExecuteFile(e[0]),_=execa_1.default.sync(e[0],e.slice(1),l),(null===(r=_.stdout)||void 0===r?void 0:r.length)>0&&this._log.debug(iconv.decode(_.stdout,this._ohosCharset)),(null===(s=_.stderr)||void 0===s?void 0:s.length)>0&&(o?this._log.debug(iconv.decode(_.stderr,this._ohosCharset)):this._log.warn(iconv.decode(_.stderr,this._ohosCharset))),0!==_.exitCode&&this._log._printFailedTaskInfo(this._moduleName,this._taskName)._buildError(this._errlog)._solution(iconv.decode(_.stderr,this._ohosCharset))._printErrorAndExit(this._moduleName)}catch(e){this._log._printFailedTaskInfo(this._moduleName,this._taskName),(null===(i=e.stdout)||void 0===i?void 0:i.length)>0&&this._log.error(iconv.decode(e.stdout,this._ohosCharset)),e.stderr?this._log._buildError(`${this._errlog}${os.EOL}${iconv.decode(e.stderr,this._ohosCharset)}`):this._log._buildError(`${this._errlog}${os.EOL}${e.message}`),this._log._solution(this._solution),this._log._printErrorAndExit(this._moduleName)}return _}processOptionsFactory(e){var t;const o=process.env.PATH;return(null===(t=null==e?void 0:e.env)||void 0===t?void 0:t.path)&&o&&(e.env.path=o+((0,system_util_js_1.isWindows)()?";":":")+e.env.path),{...this._defaultOptions,...e}}validateExecuteFile(e){"java"!==e&&"javac"!==e&&(fs_1.default.existsSync(path_1.default.normalize(e))||this._log._buildError("Not an internal or external command, nor a runnable program Or batch files.")._file(e)._printErrorAndExit(this._moduleName))}}exports.ProcessUtils=ProcessUtils;