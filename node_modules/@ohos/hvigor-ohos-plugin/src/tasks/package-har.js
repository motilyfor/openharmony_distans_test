"use strict";var __createBinding=this&&this.__createBinding||(Object.create?function(e,s,t,i){void 0===i&&(i=t);var r=Object.getOwnPropertyDescriptor(s,t);r&&!("get"in r?!s.__esModule:r.writable||r.configurable)||(r={enumerable:!0,get:function(){return s[t]}}),Object.defineProperty(e,i,r)}:function(e,s,t,i){void 0===i&&(i=t),e[i]=s[t]}),__setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(e,s){Object.defineProperty(e,"default",{enumerable:!0,value:s})}:function(e,s){e.default=s}),__importStar=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var s={};if(null!=e)for(var t in e)"default"!==t&&Object.prototype.hasOwnProperty.call(e,t)&&__createBinding(s,e,t);return __setModuleDefault(s,e),s},__importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.PackageHar=void 0;const syscap_transform_js_1=require("./syscap-transform.js"),ohos_hap_task_js_1=require("./task/ohos-hap-task.js"),path_1=__importDefault(require("path")),fs=__importStar(require("fs-extra")),process_utils_js_1=require("../utils/process-utils.js"),build_directory_const_js_1=require("../const/build-directory-const.js"),common_const_js_1=require("../const/common-const.js"),npm_command_builder_js_1=require("../builder/npm-command-builder.js"),task_names_js_1=require("./common/task-names.js"),process_libs_js_1=require("./process-libs.js"),compile_resource_js_1=require("./compile-resource.js"),legacy_compile_resource_js_1=require("./legacy-tasks/legacy-compile-resource.js");var Task=task_names_js_1.TaskNames.Task;const cmake_util_js_1=require("../utils/cmake-util.js");class PackageHar extends ohos_hap_task_js_1.OhosHapTask{constructor(e){var s;super(e,Task.PACKAGE_HAR),this._moduleDir=e.getModuleModel().getProjectDir();const t=e.getModuleModel().getProfileOpt();this._nativeOption=null===(s=t.buildOption)||void 0===s?void 0:s.externalNativeOptions,this._sdkInfo=this.service.getSdkInfo()}initTaskDepends(){this.module.registryDependsOnTask(this,new process_libs_js_1.ProcessLibs(this.service),this.isFaMode?new legacy_compile_resource_js_1.LegacyCompileResource(this.service):new compile_resource_js_1.CompileResource(this.service),new syscap_transform_js_1.SyscapTransform(this.service))}doTaskAction(e){var s,t;const i=e.getPathInfo(),r=null===(s=this.service.getModuleModel())||void 0===s?void 0:s.getProjectDir(),o=i.getIntermediatesProcessLibs(),a=i.getIntermediatesRes();fs.emptyDirSync(i.getModuleBuildOutputPath()),fs.emptyDirSync(this.getTaskTempDir(e)),fs.pathExistsSync(o)&&fs.copySync(i.getIntermediatesProcessLibs(),path_1.default.resolve(this.getTaskTempDir(e),build_directory_const_js_1.BuildDirConst.LIBS)),fs.pathExistsSync(a)&&fs.copySync(path_1.default.resolve(a,build_directory_const_js_1.BuildArtifactConst.RESOURCE_TABLE_TXT),path_1.default.resolve(this.getTaskTempDir(e),build_directory_const_js_1.BuildArtifactConst.RESOURCE_TABLE_TXT));let _=[build_directory_const_js_1.BuildDirConst.LIBS,build_directory_const_js_1.BuildDirConst.BUILD_ROOT,common_const_js_1.CommonNodeConst.NODE_MODULES,".cxx",".preview"];_.includes(i.getBuildRoot())||_.push(i.getBuildRoot()),_=_.map((e=>path_1.default.resolve(r,e)));const c=cmake_util_js_1.CmakeUtil.getCmakeListDir(this._moduleDir,null===(t=this._nativeOption)||void 0===t?void 0:t.path);if(fs.readdirSync(r).forEach((s=>{const t=path_1.default.resolve(r,s);_.includes(t)||fs.copySync(path_1.default.resolve(r,s),path_1.default.resolve(this.getTaskTempDir(e),s),{filter:e=>!(this._nativeOption&&e===c)})})),this._nativeOption){const s=path_1.default.resolve(c,"types");fs.pathExistsSync(s)&&fs.copySync(s,path_1.default.resolve(this.getTaskTempDir(e),"src","main","cpp","types"))}const n=i.getIntermediatesMergeProfileDir();fs.copySync(n,path_1.default.resolve(this.getTaskTempDir(e),"src","main"));const l=path_1.default.resolve(this.getTaskTempDir(e),"src","main",common_const_js_1.CommonConst.MODULE_JSON5);fs.pathExistsSync(l)&&fs.removeSync(l);const u=path_1.default.dirname(process.execPath),d=new npm_command_builder_js_1.NpmCommandBuilder(u);d.addAllParams(["pack"]),new process_utils_js_1.ProcessUtils(this.moduleName,this.name).executeSync(d.build(),{cwd:this.getTaskTempDir(e)},!0),fs.copySync(this.getTaskTempDir(e),i.getModuleBuildOutputPath(),{filter:s=>!fs.lstatSync(s).isDirectory()&&s.endsWith(".tgz")||s===this.getTaskTempDir(e)})}}exports.PackageHar=PackageHar;