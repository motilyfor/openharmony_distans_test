"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.LegacyCompileNode=void 0;const code_type_enum_js_1=require("../../enum/code-type-enum.js"),build_directory_const_js_1=require("../../const/build-directory-const.js"),compile_node_js_1=require("../compile-node.js"),path_1=__importDefault(require("path")),ohos_logger_js_1=require("../../utils/log/ohos-logger.js"),legacy_generate_js_manifest_js_1=require("./legacy-generate-js-manifest.js"),legacy_compile_resource_js_1=require("./legacy-compile-resource.js"),legacy_generate_loader_json_js_1=require("./legacy-generate-loader-json.js"),task_names_js_1=require("../common/task-names.js"),module_type_enum_js_1=require("../../enum/module-type-enum.js");class LegacyCompileNode extends compile_node_js_1.CompileNode{constructor(e,t){super(e,t,task_names_js_1.TaskNames.LegacyFATask.COMPILE_NODE),this._logger=ohos_logger_js_1.OhosLogger.getLogger(LegacyCompileNode.name)}initTaskDepends(){this.module.registryDependsOnTask(this,new legacy_generate_js_manifest_js_1.LegacyGenerateJsManifest(this.service),new legacy_compile_resource_js_1.LegacyCompileResource(this.service),new legacy_generate_loader_json_js_1.LegacyGenerateLoaderJson(this.service))}taskShouldDo(e){return!this.service.hasLiteDevice()}doTaskAction(e){const t=this.service.getModuleModel(),o=t.getSourceSetByTargetName(e.getTargetName()).getCodeMap().get(this.codeType);if(void 0===o)return void this._logger.debug(`Cannot find '${this.codeType}' source.`);const s=o.getSrcPath(),a=e.getPathInfo(),r=this.moduleModel.getModuleType()===module_type_enum_js_1.ModuleType.Feature?this.service.getRelatedEntryModules()[0]:"",i=path_1.default.resolve(a.getIntermediatesRes(),r,build_directory_const_js_1.BuildArtifactConst.RESOURCE_TABLE_TXT),l=path_1.default.resolve(a.getIntermediatesLegacyManifestJson()),_=path_1.default.resolve(e.getPathInfo().getIntermediatesAssetsPath(),code_type_enum_js_1.CodeType.JS),c=this.codeType===code_type_enum_js_1.CodeType.ETS?this.sdkInfo.getEtsLoader():this.sdkInfo.getJsLoader(),d=t.getLegacyAbilities(e.getTargetName());for(let o=0;o<d.length;o++){const r=d[o];if(r.getSrcLanguage()!==this.codeType)continue;const n={...this.commonOption,abilityType:r.getType(),aceManifestPath:path_1.default.resolve(l,r.getRelateSrcPath(),build_directory_const_js_1.BuildArtifactConst.LEGACY_MANIFEST_JSON),appResource:i,aceModuleRoot:path_1.default.resolve(s,r.getRelateSrcPath()),aceModuleBuild:path_1.default.resolve(_,r.getRelateSrcPath()),cachePath:this.getTaskTempDir(e),aceSuperVisualPath:path_1.default.resolve(t.getSourceRootByTargetName(e.getTargetName()),"supervisual",r.getRelateSrcPath()),aceBuildJson:path_1.default.resolve(a.getIntermediatesLoaderPath(),r.getRelateSrcPath(),build_directory_const_js_1.BuildArtifactConst.LOADER_JSON)};this.doRealLoaderCompile(c,n),this.moveReleaseMap(e,`js/${r.getRelateSrcPath()}`)}this.compileTestRunner(i,s,_,e,c)}compileTestRunner(e,t,o,s,a){var r,i,l;const _=null===(l=null===(i=null===(r=this.moduleModel.getSourceSetByTargetName(s.getTargetName()).getLegacyModuleTargetRes().getConfigJsonOpt())||void 0===r?void 0:r.module)||void 0===i?void 0:i.testRunner)||void 0===l?void 0:l.srcPath;if("ohosTest"!==s.getTargetName()||void 0===_||this.codeType!==code_type_enum_js_1.CodeType.JS)return;const c={...this.commonOption,abilityType:"testrunner",appResource:e,aceModuleRoot:path_1.default.resolve(t,_),aceModuleBuild:path_1.default.resolve(o,_),cachePath:this.getTaskTempDir(s)};this.doRealLoaderCompile(a,c)}}exports.LegacyCompileNode=LegacyCompileNode;