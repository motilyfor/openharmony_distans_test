"use strict";var __createBinding=this&&this.__createBinding||(Object.create?function(e,t,s,a){void 0===a&&(a=s);var i=Object.getOwnPropertyDescriptor(t,s);i&&!("get"in i?!t.__esModule:i.writable||i.configurable)||(i={enumerable:!0,get:function(){return t[s]}}),Object.defineProperty(e,a,i)}:function(e,t,s,a){void 0===a&&(a=s),e[a]=t[s]}),__setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),__importStar=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var s in e)"default"!==s&&Object.prototype.hasOwnProperty.call(e,s)&&__createBinding(t,e,s);return __setModuleDefault(t,e),t},__importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.LegacyPackageHap=void 0;const path_1=__importDefault(require("path")),packing_tool_options_js_1=require("../../builder/inner-java-command-builder/packing-tool-options.js"),common_const_js_1=require("../../const/common-const.js"),build_directory_const_js_1=require("../../const/build-directory-const.js"),process_utils_js_1=require("../../utils/process-utils.js"),ohos_hap_task_js_1=require("../task/ohos-hap-task.js"),ohos_logger_js_1=require("../../utils/log/ohos-logger.js"),fse=__importStar(require("fs-extra")),legacy_make_pack_info_js_1=require("./legacy-make-pack-info.js"),process_libs_js_1=require("../process-libs.js"),legacy_compile_node_js_1=require("./legacy-compile-node.js"),code_type_enum_js_1=require("../../enum/code-type-enum.js"),task_names_js_1=require("../common/task-names.js"),build_native_with_ninja_js_1=require("../build-native-with-ninja.js"),runtime_type_enum_js_1=require("../../enum/runtime-type-enum.js"),sign_shell_js_1=require("../shell/sign-shell.js"),syscap_transform_js_1=require("../syscap-transform.js"),legacy_sign_lite_bin_js_1=require("./legacy-sign-lite-bin.js"),module_type_enum_js_1=require("../../enum/module-type-enum.js");var LegacyFATask=task_names_js_1.TaskNames.LegacyFATask;class LegacyPackageHap extends ohos_hap_task_js_1.OhosHapTask{constructor(e){super(e,LegacyFATask.PACKAGE_HAP),this._log=ohos_logger_js_1.OhosLogger.getLogger(LegacyPackageHap.name)}initTaskDepends(){this.module.registryDependsOnTask(this,new legacy_make_pack_info_js_1.LegacyMakePackInfo(this.service),new process_libs_js_1.ProcessLibs(this.service),new legacy_compile_node_js_1.LegacyCompileNode(this.service,code_type_enum_js_1.CodeType.ETS),new legacy_compile_node_js_1.LegacyCompileNode(this.service,code_type_enum_js_1.CodeType.JS),new build_native_with_ninja_js_1.BuildNativeWithNinja(this.service),new syscap_transform_js_1.SyscapTransform(this.service)),this.service.hasHOSTarget()&&this.module.registryDependsOnTask(this,new sign_shell_js_1.SignShell(this.service)),this.service.hasLiteDevice()&&this.module.registryDependsOnTask(this,new legacy_sign_lite_bin_js_1.LegacySignLiteBin(this.service))}doTaskAction(e){this.service.needPackBin()?this.buildHapBinBuilder(e):this.buildHapBuilder(e)}buildHapBuilder(e){if(this.moduleModel.getModuleType()===module_type_enum_js_1.ModuleType.Feature)for(const t of this.service.getRelatedEntryModules())this.module.findModuleByName(t)&&this.buildHapPackageOptions(e,t);else this.buildHapPackageOptions(e)}buildHapPackageOptions(e,t=""){const s=e.getPathInfo(),a=this.service.getSdkInfo().getPackageTool(),i=new packing_tool_options_js_1.PackingToolOptions;if(i.addCalledJarFile(a),i.addMode("hap").force(!0).addLibPath(path_1.default.resolve(s.getIntermediatesProcessLibs())).addJsonPath(path_1.default.resolve(s.getIntermediatesRes(),t,common_const_js_1.CommonConst.CONFIG_JSON)).addResourcesPath(path_1.default.resolve(s.getIntermediatesRes(),t,build_directory_const_js_1.BuildDirConst.RESTOOL_BUILD_RESOURCES)).addAssetsPath(path_1.default.resolve(s.getIntermediatesAssetsPath())).addIndexPath(path_1.default.resolve(s.getIntermediatesRes(),t,build_directory_const_js_1.BuildArtifactConst.RESOURCE_INDEX)).addPackInfoPath(path_1.default.resolve(s.getModuleBuildOutputPath(),t,build_directory_const_js_1.BuildArtifactConst.PACK_INFO)).addOutPath(path_1.default.resolve(s.getModuleBuildOutputPath(),e.getModuleTargetOutputFileName(t,!1))),e.getTargetStatus().is(runtime_type_enum_js_1.RuntimeTypeEnum.HARMONY_OS)){const a=[path_1.default.resolve(s.getIntermediatesApkDir(),e.getApkName())],o=e.findTargetDataByName(t);o&&"ohosTest"!==e.getTargetName()&&a.push(path_1.default.resolve(s.getIntermediatesApkDir(),o.getApkName(!0))),i.addDexPath(path_1.default.resolve(s.getIntermediatesDexDir(),"classes.dex")).addShellApkPath(a)}const o=path_1.default.resolve(s.getIntermediatesSysCap(),common_const_js_1.CommonConst.RPCID_SC);fse.existsSync(o)&&i.addSysCapPath(o),this.executeCommandList(i)}buildHapBinBuilder(e){const t=e.getPathInfo(),s=new packing_tool_options_js_1.PackingToolOptions;s.addCalledJarFile(this.service.getSdkInfo().getPackageTool()),s.addMode("hap").addBinPath(path_1.default.resolve(t.getModuleBinOutput(),e.getModuleTargetOutputFileName("",null,build_directory_const_js_1.BuildArtifactExtension.DOT_BIN))).addOutPath(path_1.default.resolve(t.getModuleBuildOutputPath(),e.getModuleTargetOutputFileName("",!1))).force(!0),this.executeCommandList(s)}executeCommandList(e){this._log._printDebugCommand("PackageHap",e.commandList),new process_utils_js_1.ProcessUtils(this.moduleName,this.name).executeSync(e.commandList)}}exports.LegacyPackageHap=LegacyPackageHap;