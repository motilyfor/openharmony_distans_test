"use strict";var __createBinding=this&&this.__createBinding||(Object.create?function(e,t,o,s){void 0===s&&(s=o);var r=Object.getOwnPropertyDescriptor(t,o);r&&!("get"in r?!t.__esModule:r.writable||r.configurable)||(r={enumerable:!0,get:function(){return t[o]}}),Object.defineProperty(e,s,r)}:function(e,t,o,s){void 0===s&&(s=o),e[s]=t[o]}),__setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),__importStar=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var o in e)"default"!==o&&Object.prototype.hasOwnProperty.call(e,o)&&__createBinding(t,e,o);return __setModuleDefault(t,e),t},__importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.CompileNode=void 0;const code_type_enum_js_1=require("../enum/code-type-enum.js"),path_1=__importDefault(require("path")),fse=__importStar(require("fs-extra")),ohos_hap_task_js_1=require("./task/ohos-hap-task.js"),node_command_builder_js_1=require("../builder/node-command-builder.js"),common_const_js_1=require("../const/common-const.js"),process_utils_js_1=require("../utils/process-utils.js"),build_directory_const_js_1=require("../const/build-directory-const.js"),ohos_logger_js_1=require("../utils/log/ohos-logger.js"),generate_loader_json_js_1=require("./generate-loader-json.js"),compile_resource_js_1=require("./compile-resource.js"),inject_util_js_1=require("../utils/inject-util.js"),project_file_reader_js_1=require("../utils/project-file-reader.js");class CompileNode extends ohos_hap_task_js_1.OhosHapTask{constructor(e,t,o){super(e,{...o,name:`${CompileNode.getCompileNodeTaskName(t,o.name)}`}),this.commonOption={path:path_1.default.dirname(process.execPath),watchMode:"false"},this._log=ohos_logger_js_1.OhosLogger.getLogger(CompileNode.name),this.codeType=t}static getCompileNodeTaskName(e,t){return`${t}${e.toUpperCase()}`}initTaskDepends(){this.module.registryDependsOnTask(this,new generate_loader_json_js_1.GenerateLoaderJson(this.service),new compile_resource_js_1.CompileResource(this.service))}doTaskAction(e){this.validateModuleJson(e),this.doRealLoaderCompile(this.codeType===code_type_enum_js_1.CodeType.ETS?this.sdkInfo.getEtsLoader():this.sdkInfo.getJsLoader(),this.generateLoaderEnv(e)),this.moveReleaseMap(e)}taskShouldDo(e){return this.codeModel=this.moduleModel.getSourceSetByTargetName(e.getTargetName()).getCodeMap().get(this.codeType),void 0!==this.codeModel}moveReleaseMap(e,t=this.codeType){const o=path_1.default.resolve(e.getPathInfo().getIntermediatesAssetsPath(),t,build_directory_const_js_1.BuildArtifactConst.RELEASE_MAP);if(!fse.existsSync(o))return;const s=path_1.default.resolve(this.getTaskTempDir(e),t,build_directory_const_js_1.BuildArtifactConst.RELEASE_MAP);fse.existsSync(s)&&fse.removeSync(s),fse.moveSync(o,s),this._log.debug(`move ${o} to ${s}`)}doRealLoaderCompile(e,t){const o=new node_command_builder_js_1.NodeCommandBuilder(!0).addWebpackPath("./node_modules/webpack/bin/webpack.js").addWebpackConfig(this.codeType===code_type_enum_js_1.CodeType.ETS?common_const_js_1.CommonConst.ETS_WEBPACK_FILE:common_const_js_1.CommonConst.ACE_RICH_WEBPACK_FILE).addBuildMode(inject_util_js_1.InjectUtil.isDebug());this.service.isArkModule()&&o.addCompilerType("ark"),this._log._printDebugCommand("NodeEnv",t),this._log._printDebugCommand(`${this.codeType.toUpperCase()}-loader`,o.build());const s={cwd:e,env:t};new process_utils_js_1.ProcessUtils(this.moduleName,this.name).executeSync(o.build(),s)}generateLoaderEnv(e){const t=e.getPathInfo();return{...this.commonOption,appResource:path_1.default.resolve(t.getIntermediatesRes(),build_directory_const_js_1.BuildArtifactConst.RESOURCE_TABLE_TXT),aceModuleBuild:path_1.default.resolve(t.getIntermediatesAssetsPath(),this.codeType),aceModuleRoot:this.codeModel.getSrcPath(),cachePath:this.getTaskTempDir(e),aceProfilePath:t.getIntermediatesResProfilePath(),aceModuleJsonPath:path_1.default.resolve(t.getIntermediatesRes(),common_const_js_1.CommonConst.MODULE_JSON),aceSuperVisualPath:path_1.default.resolve(this.moduleModel.getSourceRootByTargetName(e.getTargetName()),"supervisual"),aceBuildJson:path_1.default.resolve(t.getIntermediatesLoaderPath(),build_directory_const_js_1.BuildArtifactConst.LOADER_JSON)}}validateModuleJson(e){this.validateModulePage(e.getPathInfo()),this.validateModuleSrcEntrance(e)}validateModulePage(e){const t=path_1.default.resolve(e.getIntermediatesRes(),common_const_js_1.CommonConst.MODULE_JSON),o=project_file_reader_js_1.ProjectFileReader.getJson5Obj(t).module.pages,s=`${o.replace(/\$profile:/,"")}.json`,r=path_1.default.resolve(e.getIntermediatesResProfilePath(),s);fse.existsSync(r)||this._log._buildError(`module-pages: ${o} does not exist.`)._solution(`Make sure /resources/base/profile/${s}.json existing.`)._printErrorAndExit()}validateModuleSrcEntrance(e){const t=e.getPathInfo(),o=path_1.default.resolve(t.getIntermediatesRes(),common_const_js_1.CommonConst.MODULE_JSON),s=project_file_reader_js_1.ProjectFileReader.getJson5Obj(o).module.srcEntrance,r=this.service.getModuleModel().getSourceSetByTargetName(e.getTargetName()).getSourceSetRoot(),i=path_1.default.isAbsolute(s)?s:path_1.default.resolve(r,s);fse.existsSync(i)||this._log._buildError(`module-srcEntrance: ${s} does not exist.`)._solution(`Make sure ${s}.json existing.`)._file(i)._printErrorAndExit()}}exports.CompileNode=CompileNode;