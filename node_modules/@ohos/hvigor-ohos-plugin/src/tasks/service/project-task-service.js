"use strict";var __importDefault=this&&this.__importDefault||function(t){return t&&t.__esModule?t:{default:t}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.ProjectTaskService=void 0;const task_service_js_1=require("./task-service.js"),hap_plugin_js_1=require("../../plugin/hap-plugin.js"),array_util_js_1=require("../../utils/array-util.js"),find_target_product_js_1=require("../../common/find-target-product.js"),build_directory_const_js_1=require("../../const/build-directory-const.js"),project_path_info_iml_js_1=require("../../common/iml/project-path-info-iml.js"),sdk_info_js_1=require("../../sdk/sdk-info.js"),sdkmanager_common_1=require("@ohos/sdkmanager-common"),default_plugin_id_js_1=require("../../plugin/common/default-plugin-id.js"),ohos_logger_js_1=require("../../utils/log/ohos-logger.js"),util_1=__importDefault(require("util")),path_1=__importDefault(require("path")),common_const_js_1=require("../../const/common-const.js");class ProjectTaskService extends task_service_js_1.TaskService{constructor(t,e,r,o){super(t,e,r),this._log=ohos_logger_js_1.OhosLogger.getLogger(ProjectTaskService.name),this.initProductData=()=>{const t=this.hvigorNode;null==t||t.getSubModules().forEach((t=>{var e;const r=t.getName(),o=t.getPluginById(default_plugin_id_js_1.DefaultPluginId.OHOS_HAP_PLUGIN),i=[];if(void 0!==o&&o instanceof hap_plugin_js_1.HapPlugin){const t=null===(e=this._projectModel)||void 0===e?void 0:e.getModuleProfileOpt(r),s=null==t?void 0:t.targets,_=o.getTaskService().getTargetDataSet(),a=new Set;_.forEach((t=>{t[1]&&void 0!==(0,array_util_js_1.getElementFromArr)(s,t[0].getTargetName())&&i.push(t[0]),a.add(t[0].getTargetName())})),this.checkTargets(a,s),0!==i.length&&this._productDataMap.set(r,i)}}))},this._targetProduct=(0,find_target_product_js_1.findTargetProduct)(e),this._moduleDependencyInfo=r,this._sdkInfo=new sdk_info_js_1.SdkInfo(e.getCompileApiVersion(),[sdkmanager_common_1.ComponentPath.TOOLCHAINS]),this._pathInfo=new project_path_info_iml_js_1.ProjectPathInfoIml(e,this._targetProduct.name),this._productDataMap=new Map,this.isFamode=o,this.initProductData()}getProductDataMap(){return this._productDataMap}getPathInfo(){return this._pathInfo}getTargetProduct(){return this._targetProduct}getAppOutputFileName(t=!1){const e=t?"signed":"unsigned";return`${this._projectModel.getName()}-${this._targetProduct.name}-${e}${build_directory_const_js_1.BuildArtifactExtension.DOT_APP}`}checkTargets(t,e){var r;if(e)for(const o of e)t.has(o.name)||this._log._buildError(`Unknown target '${o.name}'!`)._solution(`Please check the module targets ${util_1.default.format(o)} name field.`)._file(path_1.default.resolve(null===(r=this._projectModel)||void 0===r?void 0:r.getProjectDir(),common_const_js_1.CommonConst.PROFILE_JSON5))._printErrorAndExit()}}exports.ProjectTaskService=ProjectTaskService;