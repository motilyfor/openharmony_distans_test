"use strict";var __importDefault=this&&this.__importDefault||function(i){return i&&i.__esModule?i:{default:i}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.CommonSignCommandBuilder=void 0;const fs_1=__importDefault(require("fs")),ohos_logger_js_1=require("../../../utils/log/ohos-logger.js"),decipher_util_js_1=require("../../../utils/decipher-util.js"),path_1=__importDefault(require("path")),error_url_js_1=require("../../../utils/error-url.js"),keystore_utils_js_1=require("../../../utils/keystore-utils.js");class CommonSignCommandBuilder{constructor(i,e,t,r,o){this._log=ohos_logger_js_1.OhosLogger.getLogger(CommonSignCommandBuilder.name),this._projectModel=i,this._signingConfig=e,this._sdkInfo=t,this._signModel=r,this._signingOptions=o}getSignCommand(){this.initCommandParams();const i=this.getSignTool();return this._signingOptions.addCalledJarFile(i),this._signingOptions.build()}getWorkDir(){return this._sdkInfo.getSignDir()}getKeyStorePwd(){const i=path_1.default.resolve(this._signingConfig.material.storeFile,"..");return this._signingConfig.material.storePassword===keystore_utils_js_1.KeyStoreHelper.DEFAULT_STORE_PASS?this._signingConfig.material.storePassword:decipher_util_js_1.DecipherUtil.decryptPwd(i,this._signingConfig.material.storePassword)}getKeyPwd(){const i=path_1.default.resolve(this._signingConfig.material.storeFile,"..");return this._signingConfig.material.keyPassword===keystore_utils_js_1.KeyStoreHelper.DEFAULT_STORE_PASS?this._signingConfig.material.keyPassword:decipher_util_js_1.DecipherUtil.decryptPwd(i,this._signingConfig.material.keyPassword)}checkValidMaterial(i){const e="Please check signingConfigs in root project build-profile.json5";void 0===i&&this._log._buildError("The material is not configured in signingConfigs.")._solution(e)._file(this._projectModel.getProfilePath())._printErrorAndExit(this._projectModel.getName()),this.validateMaterial(i.storeFile,e,"storeFile"),this.validateMaterial(i.profile,e,"profile"),this.validateMaterial(i.certpath,e,"certPath"),i.storeFile=this.normalizePath(i.storeFile),i.profile=this.normalizePath(i.profile),i.certpath=this.normalizePath(i.certpath)}normalizePath(i){return path_1.default.isAbsolute(i)?i:path_1.default.resolve(this._projectModel.getProjectDir(),i)}validateMaterial(i,e,t){void 0!==i&&fs_1.default.existsSync(this.normalizePath(i))||this._log._buildError(`Check if '${t}' is configured correctly, it can't be null or empty.file must exist at '${i}'`)._solution(e)._file(this._projectModel.getProfilePath())._printErrorAndExit(this._projectModel.getName())}validateSignType(i){void 0===this._signingConfig.type&&(this._signingConfig.type="OpenHarmony"),this._signingConfig.type!==i&&this._log._buildError(`Signing config '${this._signingConfig.name}' is not for '${i}'. The hap installation may fail.`)._solution(`see ${error_url_js_1.ErrorUrl.ERROR_URL.sign}`)._file(this._projectModel.getProfilePath())._printErrorAndExit(this._projectModel.getName())}}exports.CommonSignCommandBuilder=CommonSignCommandBuilder;