"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.PackageApp=void 0;const path_1=__importDefault(require("path")),packing_tool_options_js_1=require("../builder/inner-java-command-builder/packing-tool-options.js"),build_directory_const_js_1=require("../const/build-directory-const.js"),file_util_js_1=require("../utils/file-util.js"),ohos_logger_js_1=require("../utils/log/ohos-logger.js"),process_utils_js_1=require("../utils/process-utils.js"),task_names_js_1=require("./common/task-names.js"),make_project_pack_info_js_1=require("./make-project-pack-info.js"),pre_build_app_js_1=require("./pre-build-app.js"),ohos_app_task_js_1=require("./task/ohos-app-task.js");var Task=task_names_js_1.TaskNames.Task;const fs_extra_1=__importDefault(require("fs-extra"));class PackageApp extends ohos_app_task_js_1.OhosAppTask{constructor(e,t){super(e,t,Task.PACKAGE_APP),this._log=ohos_logger_js_1.OhosLogger.getLogger(PackageApp.name)}static writeFile(e,t){file_util_js_1.FileUtil.checkFile(e),fs_extra_1.default.writeFileSync(e,fs_extra_1.default.readFileSync(t))}initTaskDepends(){this.project.registryDependsOnTask(this,new pre_build_app_js_1.PreBuildApp(this.project,this.service)),this.project.registryDependsOnTask(this,new make_project_pack_info_js_1.MakeProjectPackInfo(this.project,this.service))}doTaskAction(){(new process_utils_js_1.ProcessUtils).executeSync(this.executePackageApp())}executePackageApp(){const e=new packing_tool_options_js_1.PackingToolOptions;e.addCalledJarFile(this.service.getSdkInfo().getPackageTool());const t=this.service.getPathInfo(),s=path_1.default.resolve(t.getProjectOutputPath(),build_directory_const_js_1.BuildArtifactConst.PACK_INFO),a=path_1.default.resolve(t.getProjectOutputPath(),build_directory_const_js_1.BuildArtifactConst.PACK_RES);return this.packRes(s,a),fs_extra_1.default.existsSync(a)&&e.addPackResPath(a),e.addMode("app").addPackInfoPath(s).addHapPath(this.getUnpackedHaps().join(",")).force(!0).addOutPath(path_1.default.resolve(t.getProjectOutputPath(),this.service.getAppOutputFileName())),this._log._printDebugCommand("PackageApp",e.commandList),e.commandList}getUnpackedHaps(){const e=[];return this.service.getProductDataMap().forEach((t=>{for(const s of t){const t=s.getPathInfo().getModuleBuildOutputPath(),a=s.getModuleTargetOutputFileName("",!1),o=path_1.default.resolve(t,a),i=path_1.default.resolve(t,"app");file_util_js_1.FileUtil.checkDirWithoutDelete(i);const r=s.getRelatedEntryModules();if(r.length)for(const a of r){const o=s.getModuleTargetOutputFileName(a,!1),r=path_1.default.resolve(t,o),_=path_1.default.resolve(i,o.replace("-unsigned",""));PackageApp.writeFile(_,r),e.push(_)}else{const t=path_1.default.resolve(i,a.replace("-unsigned",""));PackageApp.writeFile(t,o),e.push(t)}}})),e}packRes(e,t){const s=path_1.default.resolve(this.project.getNodeDir(),"EntryCard");if(!fs_extra_1.default.existsSync(s)||!fs_extra_1.default.statSync(s).isDirectory())return void fs_extra_1.default.rmSync(t,{force:!0});const a=new packing_tool_options_js_1.PackingToolOptions;a.addCalledJarFile(this.service.getSdkInfo().getPackageTool()),a.addMode("res").addEntryCardPath(s).addPackInfoPath(e).addOutPath(t).force(!0),this._log._printDebugCommand("PackRes",a.commandList),(new process_utils_js_1.ProcessUtils).executeSync(a.build())}}exports.PackageApp=PackageApp;