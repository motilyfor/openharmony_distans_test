"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.BuildNativeWithNinja=void 0;const path_1=__importDefault(require("path")),fs_extra_1=__importDefault(require("fs-extra")),native_command_builder_js_1=require("../builder/native-command-builder.js"),process_utils_js_1=require("../utils/process-utils.js"),ohos_hap_task_js_1=require("./task/ohos-hap-task.js"),cpu_abi_enum_js_1=require("../enum/cpu-abi-enum.js"),ohos_logger_js_1=require("../utils/log/ohos-logger.js"),build_native_with_cmake_js_1=require("./build-native-with-cmake.js"),task_names_js_1=require("./common/task-names.js"),generate_native_library_js_1=require("../model/cxx/generate-native-library.js"),generate_codemodel_js_1=require("../model/cxx/generate-codemodel.js");var Task=task_names_js_1.TaskNames.Task;const cmake_util_js_1=require("../utils/cmake-util.js");class BuildNativeWithNinja extends ohos_hap_task_js_1.OhosHapTask{constructor(e){var t;super(e,Task.BUILD_NATIVE_WITH_NINJA),this._log=ohos_logger_js_1.OhosLogger.getLogger(BuildNativeWithNinja.name),this._moduleModel=e.getModuleModel(),this._nativeOption=null===(t=this._moduleModel.getProfileOpt().buildOption)||void 0===t?void 0:t.externalNativeOptions}initTaskDepends(){this.module.registryDependsOnTask(this,new build_native_with_cmake_js_1.BuildNativeWithCmake(this.service))}buildCommand(e,t){const a=t.getPathInfo(),s=path_1.default.resolve(a.getNinjaWorkDir(),e),i=new native_command_builder_js_1.NativeCommandBuilder(this.sdkInfo.getNativeNinjaTool()).changeToDir(s).build();this._log._printDebugCommand("Ninja",i),new process_utils_js_1.ProcessUtils(this.moduleName,this.name).executeSync(i)}taskShouldDo(e){return cmake_util_js_1.CmakeUtil.nativeTaskCondition(this._moduleModel,e,this._nativeOption)}doTaskAction(e){var t;const a=e.getPathInfo(),s=path_1.default.resolve(a.getIntermediatesCppOutPut());fs_extra_1.default.emptyDirSync(s);cmake_util_js_1.CmakeUtil.checkAbiFilters(null===(t=this._nativeOption)||void 0===t?void 0:t.abiFilters).forEach((t=>{const i=path_1.default.resolve(a.getNinjaWorkDir(),t),o=new generate_codemodel_js_1.GenerateCodemodel(i).getCodemodel();this.buildCommand(t,e);const r=path_1.default.resolve(s,t);if(void 0!==o){const a=this.generateNativeLibraries(o,i,e.getTargetName(),t);this.syncOutput(a,r,i)}this.syncStl(t,r,a)}))}generateNativeLibraries(e,t,a,s){var i;const o=new Map;return null===(i=e.configurations)||void 0===i||i.forEach((e=>{var i;null===(i=e.targets)||void 0===i||i.forEach((e=>{const i=this.sdkInfo.getCmakeTool(),r=new generate_native_library_js_1.GenerateNativeLibrary(i,t,s,e,a).getLibrary();e.name&&o.set(e.name,r)}))})),o}syncOutput(e,t,a){e.forEach(((e,s)=>{var i,o;null===(i=e.getOutputs())||void 0===i||i.forEach((i=>{const o=path_1.default.isAbsolute(i)?path_1.default.resolve(i):path_1.default.resolve(a,i),r=e.getNameOnDisk();if(!r)return;const l=path_1.default.resolve(t,r);o!==l&&(this._log.debug(`external build set its own library output location for ${s}, hard link or copy to expected location`),fs_extra_1.default.copySync(o,l,{recursive:!0}))})),null===(o=e.getRuntimeFiles())||void 0===o||o.forEach((s=>{s=path_1.default.isAbsolute(s)?path_1.default.resolve(s):path_1.default.resolve(a,e.getBuild(),s);const i=path_1.default.parse(s),o=path_1.default.resolve(t,i.base);s!==o&&fs_extra_1.default.copySync(s,o,{recursive:!0})}))}))}syncStl(e,t,a){const s=this.getArguments(),i=s.some((e=>"-DOHOS_STL=c++_static"===e))||s.some((e=>"-DOHOS_STL=none"===e)),o=path_1.default.resolve(t,"libc++.so"),r=path_1.default.resolve(t,"libc++_shared.so"),l=path_1.default.resolve(a.getModuleBuildIntermediates(),"libs",e);if(i)return fs_extra_1.default.removeSync(o),fs_extra_1.default.removeSync(r),void fs_extra_1.default.removeSync(l);const _=path_1.default.resolve(this.sdkInfo.getSdkNativeDir(),"llvm","lib",cpu_abi_enum_js_1.CpuAbiEnum.getCpuType(e),"c++"),n=path_1.default.resolve(_,"libc++_shared.so");fs_extra_1.default.existsSync(n)&&fs_extra_1.default.copySync(n,r)}getArguments(){var e;const t=null===(e=this._nativeOption)||void 0===e?void 0:e.arguments;return t&&""!==t?t.split(" "):[]}}exports.BuildNativeWithNinja=BuildNativeWithNinja;