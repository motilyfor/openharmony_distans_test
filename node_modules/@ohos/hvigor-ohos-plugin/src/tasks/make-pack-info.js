"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.MakePackInfo=void 0;const ohos_logger_js_1=require("../utils/log/ohos-logger.js"),task_names_js_1=require("./common/task-names.js"),merge_profile_js_1=require("./merge-profile.js");var Task=task_names_js_1.TaskNames.Task;const abstract_make_pack_info_js_1=require("./abstract-make-pack-info.js");class MakePackInfo extends abstract_make_pack_info_js_1.AbstractMakePackInfo{constructor(e){super(e,Task.MAKE_PACK_INFO),this._log=ohos_logger_js_1.OhosLogger.getLogger(MakePackInfo.name)}initTaskDepends(){this.module.registryDependsOnTask(this,new merge_profile_js_1.MergeProfile(this.service))}doTaskAction(e){const s=this.service.getModuleModel(),o=e.getTargetName(),t=s.getJsonObjByTargetName(o),i=this.service.getProjectModel(),a=i.getAppRes().getAppResOpt(),r={code:a.app.versionCode,name:a.app.versionName,minCompatibleVersionCode:a.app.minCompatibleVersionCode},n={bundleName:a.app.bundleName,version:r},l=this.getModuleObj(t,a,s,o),c=this.service.getRelatedEntryModules();if(c.length){for(const s of c)if(i.getModuleModelByName(s)){const r=i.getModuleModelByName(s),c=r.getJsonObjByTargetName(o),d=this.getModuleObj(c,a,r,o);this.buildPackInfo(this._log,s,e,t,n,l,c,d)}}else this.buildPackInfo(this._log,"",e,t,n,l,void 0,void 0)}processExtensionAbilities(e,s,o){if(void 0===e)return;const t=[];for(const i of e){const e={name:i.name,forms:this.processForms(MakePackInfo.processMetaData(i.metadata,s,o))};t.push(e)}return t}static processMetaData(e,s,o){if(void 0===e)return;const t=[];for(const i of e){const e=MakePackInfo.processResourcePath(i.resource);if(i.name.indexOf("form")>=0&&void 0!==e){const i=s.getFormJsonObjByTargetName(o,e).forms;for(let e=0;e<i.length;e++)t.push(i[e])}}return t}static processResourcePath(e){if(!e)return;const s=e.split(":");return 2!==s.length||"$"!==s[0].charAt(0)||s[0].length<2?void 0:`base/${s[0].substring(1)}/${s[1]}.json`}getModuleObj(e,s,o,t){const i={moduleType:e.module.type,installationFree:e.module.installationFree,deliveryWithInstall:e.module.deliveryWithInstall,moduleName:e.module.name},a={compatible:s.app.minAPIVersion,releaseType:s.app.apiReleaseType,target:s.app.targetAPIVersion};return{mainAbility:e.module.mainElement,deviceType:e.module.deviceTypes,abilities:this.processAbilities(e.module.abilities),extensionAbilities:this.processExtensionAbilities(e.module.extensionAbilities,o,t),distro:i,apiVersion:a}}getPackageObj(e,s,o){return{deviceType:o?o.module.deviceTypes:e.module.deviceTypes,moduleType:e.module.type,deliveryWithInstall:e.module.deliveryWithInstall,name:s}}}exports.MakePackInfo=MakePackInfo;