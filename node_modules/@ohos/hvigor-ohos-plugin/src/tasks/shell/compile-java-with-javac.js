"use strict";var __createBinding=this&&this.__createBinding||(Object.create?function(e,t,s,a){void 0===a&&(a=s);var i=Object.getOwnPropertyDescriptor(t,s);i&&!("get"in i?!t.__esModule:i.writable||i.configurable)||(i={enumerable:!0,get:function(){return t[s]}}),Object.defineProperty(e,a,i)}:function(e,t,s,a){void 0===a&&(a=s),e[a]=t[s]}),__setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),__importStar=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var s in e)"default"!==s&&Object.prototype.hasOwnProperty.call(e,s)&&__createBinding(t,e,s);return __setModuleDefault(t,e),t},__importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.CompileJavaWithJavac=void 0;const ohos_logger_js_1=require("../../utils/log/ohos-logger.js"),process_utils_js_1=require("../../utils/process-utils.js"),java_compile_command_builder_js_1=require("../../builder/java-compile-command-builder.js"),file_util_js_1=require("../../utils/file-util.js"),fs_1=__importDefault(require("fs")),path_1=__importDefault(require("path")),os=__importStar(require("os")),glob_1=require("glob"),fs_extra_1=__importDefault(require("fs-extra")),runtime_type_enum_js_1=require("../../enum/runtime-type-enum.js"),ohos_shell_hap_task_js_1=require("./ohos-shell-hap-task.js"),task_names_js_1=require("../common/task-names.js"),generate_java_files_js_1=require("./generate-java-files.js");var ShellTask=task_names_js_1.TaskNames.ShellTask;class CompileJavaWithJavac extends ohos_shell_hap_task_js_1.OhosShellHapTask{constructor(e){super(e,ShellTask.COMPILE_SHELL_JAVA_WITH_JAVAC),this._log=ohos_logger_js_1.OhosLogger.getLogger(CompileJavaWithJavac.name)}initTaskDepends(){this.module.registryDependsOnTask(this,new generate_java_files_js_1.GenerateJavaFiles(this.service))}taskShouldDo(e){return e.getTargetStatus().is(runtime_type_enum_js_1.RuntimeTypeEnum.HARMONY_OS)}beforeTask(e){fs_extra_1.default.emptyDirSync(e.getPathInfo().getIntermediatesClassDir()),fs_extra_1.default.emptyDirSync(e.getPathInfo().getIntermediatesShellClassDir())}doTaskAction(e){const t=e.getPathInfo();this.compileJavaFiles(t.getIntermediatesShellJavaDir(),t.getIntermediatesShellClassDir(),[this.getHosSdkInfo().getAbilityShellJar(),this.getHosSdkInfo().getAceJar(),this.getHosSdkInfo().getAJar()]),this.compileJavaFiles(t.getIntermediatesJavaDir(),t.getIntermediatesClassDir(),[this.getHosSdkInfo().getOhosJar()])}compileJavaFiles(e,t,s){const a=this.getJavaFileList(e),i=(new java_compile_command_builder_js_1.JavaCompileCommandBuilder).addEncoding("UTF-8").addTarget("8").addSource("8").addIndexFile(a).addDest(t).addClasspath(s.join(path_1.default.delimiter));this._log.debug(i.build()),(new process_utils_js_1.ProcessUtils).executeSync(i.build(),{stderr:"ignore",stdout:"ignore"})}getJavaFileList(e){const t=path_1.default.resolve(e,"**","*.java"),s=new glob_1.Glob(t,{nonull:!0,matchBase:!0,sync:!0}).found,a=path_1.default.resolve(e,"javaList");file_util_js_1.FileUtil.checkDirWithoutDelete(e),file_util_js_1.FileUtil.checkFile(a);let i="";for(let e=0;e<s.length;e++)i+=s[e]+os.EOL;return fs_1.default.writeFileSync(a,i),a}}exports.CompileJavaWithJavac=CompileJavaWithJavac;