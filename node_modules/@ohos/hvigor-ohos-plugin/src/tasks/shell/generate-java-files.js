"use strict";var __createBinding=this&&this.__createBinding||(Object.create?function(e,t,a,r){void 0===r&&(r=a);var l=Object.getOwnPropertyDescriptor(t,a);l&&!("get"in l?!t.__esModule:l.writable||l.configurable)||(l={enumerable:!0,get:function(){return t[a]}}),Object.defineProperty(e,r,l)}:function(e,t,a,r){void 0===r&&(r=a),e[r]=t[a]}),__setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),__importStar=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var a in e)"default"!==a&&Object.prototype.hasOwnProperty.call(e,a)&&__createBinding(t,e,a);return __setModuleDefault(t,e),t},__importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.GenerateJavaFiles=void 0;const fse=__importStar(require("fs-extra")),path_1=__importDefault(require("path")),runtime_type_enum_js_1=require("../../enum/runtime-type-enum.js"),legacy_form_model_impl_js_1=require("../../model/ability/legacy-form-model-impl.js"),ohos_logger_js_1=require("../../utils/log/ohos-logger.js"),task_names_js_1=require("../common/task-names.js"),pre_build_js_1=require("../pre-build.js"),ohos_hap_task_js_1=require("../task/ohos-hap-task.js");var ShellTask=task_names_js_1.TaskNames.ShellTask;class GenerateJavaFiles extends ohos_hap_task_js_1.OhosHapTask{constructor(e){super(e,ShellTask.GENERATE_SHELL_JAVA_FILES)}static getShellFileNameByAbilityType(e,t){switch(e){case"page":return`${t}ShellActivity`;case"form":case"service":return`${t}ShellService`;case"data":return`${t}ShellProvider`;default:ohos_logger_js_1.OhosLogger.getLogger("abilityEnum")._printErrorAndExit(`Invalid ability type: ${e}`),process.exit(-1)}}static createShellAppJavaFile(e,t){const a=path_1.default.resolve(__dirname,"../../../res/template/ability/shell/app-shell.temp");let r=fse.readFileSync(a).toString();const l=e.module.name,s=`Shell${"."===l.charAt(0)?l.substring(1):l}`;r=r.replace("APPLICATION_NAME",s);const i=e.module.package;r=r.replace("PACKAGE_NAME",i);const o=i.replace(/\./g,"/"),n=path_1.default.resolve(t.getIntermediatesShellJavaDir(),o,`${s}.java`);fse.outputFileSync(n,r)}static createShellJavaFile(e,t,a){const r=e.getType(),l=path_1.default.resolve(__dirname,`../../../res/template/ability/shell/${r}-shell.temp`);let s=fse.readFileSync(l).toString();const i="."===e.getName().charAt(0)?e.getName().substring(1):e.getName(),o=GenerateJavaFiles.getShellFileNameByAbilityType(r,i);s=s.replace("SHELL_NAME",o);const n=a.module.package;s=s.replace("PACKAGE_NAME",n);const c=n.replace(/\./g,"/"),_=path_1.default.resolve(t.getPathInfo().getIntermediatesShellJavaDir(),c,`${o}.java`);fse.outputFileSync(_,s)}static createJavaFile(e,t,a){const r=e.getType(),l=path_1.default.resolve(__dirname,`../../../res/template/ability/${r}.temp`);let s=fse.readFileSync(l).toString();const i="."===e.getName().charAt(0)?e.getName().substring(1):e.getName();s=s.replace("ABILITY_NAME",i);const o=a.module.package;s=s.replace("PACKAGE_NAME",o);const n=e.getRelateSrcPath();s=s.replace("ABILITY_SRC_PATH",n);const c=o.replace(/\./g,"/"),_=path_1.default.resolve(t.getPathInfo().getIntermediatesJavaDir(),c,`${i}.java`);fse.outputFileSync(_,s)}static copeTestRunnerFile(e){const t=fse.readFileSync(path_1.default.resolve(__dirname,"../../../res/template/test/Runner.temp")).toString(),a=path_1.default.resolve(e.getPathInfo().getIntermediatesJavaDir(),"ohos/testkit/runner/Runner.java");fse.outputFileSync(a,t)}static copyShellComponentProxy(e,t){let a=fse.readFileSync(path_1.default.resolve(__dirname,"../../../res/template/touch/ShellComponentProxy.temp"),{encoding:"utf-8"});const r=t.module.package;a=a.replace("PACKAGE_NAME",r);const l=r.replace(/\./g,"/"),s=path_1.default.resolve(e.getPathInfo().getIntermediatesShellJavaDir(),l,"ShellComponentProxy.java");fse.outputFileSync(s,a)}initTaskDepends(){this.module.registryDependsOnTask(this,new pre_build_js_1.PreBuild(this.service))}taskShouldDo(e){return e.getTargetStatus().is(runtime_type_enum_js_1.RuntimeTypeEnum.HARMONY_OS)}beforeTask(e){fse.emptyDirSync(e.getPathInfo().getIntermediatesJavaDir()),fse.emptyDirSync(e.getPathInfo().getIntermediatesShellJavaDir())}doTaskAction(e){var t,a;const r=this.service.getModuleModel(),l=r.getJsonObjByTargetName(e.getTargetName()),s=r.getLegacyAbilities(e.getTargetName());for(let t=0;t<s.length;t++)s[t]instanceof legacy_form_model_impl_js_1.LegacyFormModelImpl||(GenerateJavaFiles.createJavaFile(s[t],e,l),GenerateJavaFiles.createShellJavaFile(s[t],e,l));GenerateJavaFiles.createShellAppJavaFile(l,e.getPathInfo()),"ohosTest"===e.getTargetName()&&GenerateJavaFiles.copeTestRunnerFile(e),!0===(null===(a=null===(t=l.deviceConfig)||void 0===t?void 0:t.default)||void 0===a?void 0:a.allowComponentsProxy)&&GenerateJavaFiles.copyShellComponentProxy(e,l)}}exports.GenerateJavaFiles=GenerateJavaFiles;