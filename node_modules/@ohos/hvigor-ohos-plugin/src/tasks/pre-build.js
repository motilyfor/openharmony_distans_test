"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.PreBuild=void 0;const fs_1=__importDefault(require("fs")),os_1=__importDefault(require("os")),path_1=__importDefault(require("path")),build_directory_const_1=require("../const/build-directory-const"),common_const_js_1=require("../const/common-const.js"),module_type_enum_js_1=require("../enum/module-type-enum.js"),runtime_type_enum_js_1=require("../enum/runtime-type-enum.js"),hap_extra_info_js_1=require("../project/data/hap-extra-info.js"),hos_sdk_info_js_1=require("../sdk/hos-sdk-info.js"),ohos_logger_js_1=require("../utils/log/ohos-logger.js"),project_file_reader_js_1=require("../utils/project-file-reader.js"),validate_util_js_1=require("../utils/validate-util.js"),task_names_js_1=require("./common/task-names.js"),ohos_hap_task_js_1=require("./task/ohos-hap-task.js");var CommonTask=task_names_js_1.TaskNames.CommonTask;class PreBuild extends ohos_hap_task_js_1.OhosHapTask{constructor(e){super(e,CommonTask.PRE_BUILD),this._log=ohos_logger_js_1.OhosLogger.getLogger(PreBuild.name)}initTaskDepends(){}doTaskAction(e){var t;const o=e.getTargetName();this.versionCheck(),this.runtimeOSCheck(e),this.service.getHapExtraInfo().isStageMode()?(this.appJson5Validate(),this.moduleJson5Validate(o),this.validateHMServiceBundleName(o),(null===(t=this.service.getModuleModel())||void 0===t?void 0:t.isHapModule())&&this.validateMainElementAndAbilities(o)):this.configJsonValidate(e)}appJson5Validate(){const e=this.service.getSdkInfo().getAppSchema(),t=require(e);this.moduleModel.getModuleType()===module_type_enum_js_1.ModuleType.Har&&(t.properties.app.required=["bundleName","versionCode","versionName"]);const o=this.service.getProjectModel(),i=o.getAppRes().getJsonPath();validate_util_js_1.ValidateUtil.doSchemaCheck(o.getName(),i,t)}moduleJson5Validate(e){const t=this.service.getSdkInfo().getModuleSchema(),o=require(t),i=this.service.getModuleModel(),s=i.getName(),r=i.getSourceSetByTargetName(e).getModuleTargetRes(),a=r.getJsonPath();validate_util_js_1.ValidateUtil.doSchemaCheck(s,a,o),e!==common_const_js_1.DefaultTargetConst.OHOS_TEST_TARGET&&this.validateModuleName(s,r.getModuleJsonOpt().module.name,common_const_js_1.CommonConst.MODULE_JSON5);const l=project_file_reader_js_1.ProjectFileReader.getJson5Obj(a);if(validate_util_js_1.ValidateUtil.validateHybridDeviceTypes(l.module.deviceTypes),!l.module.extensionAbilities)return;const n=this.service.getSdkInfo().getFormSchema(),d=require(n);for(const e of l.module.extensionAbilities)if(e.metadata&&"form"===e.type)for(const t of e.metadata)if(t.resource){const e=`${t.resource.replace(/\$profile:/,"")}.json`,o=path_1.default.resolve(r.getResourcePath(),build_directory_const_1.BuildDirConst.BASE,build_directory_const_1.BuildDirConst.PROFILE,e);this.formJsonFileCheck(o,t,a),validate_util_js_1.ValidateUtil.doSchemaCheck(s,o,d)}}formJsonFileCheck(e,t,o){if(!fs_1.default.existsSync(e)){const e=fs_1.default.readFileSync(o).toString().split("\n");let i=-1,s=-1;e.some(((e,o)=>-1!==(s=e.indexOf(t.resource))&&(i=o,!0))),this._log.errorMessageExit(`Cannot resolve symbol '${t.resource}'${os_1.default.EOL}\t at ${o}:${i+1}:${s+1+t.resource.length}`)}}configJsonValidate(e){const t=e.getTargetName(),o=e.getTargetStatus().is(runtime_type_enum_js_1.RuntimeTypeEnum.HARMONY_OS)?hos_sdk_info_js_1.HosSdkInfo.getInstance(this.moduleModel.getCompileApiVersion()):this.service.getSdkInfo(),i=this.service.hasLiteDevice()?o.getLiteSchema():o.getRichSchema(),s=require(i),r=this.service.getModuleModel(),a=r.getName(),l=r.getSourceSetByTargetName(t).getLegacyModuleTargetRes(),n=l.getJsonPath();validate_util_js_1.ValidateUtil.doSchemaCheck(a,n,s),t!==common_const_js_1.DefaultTargetConst.OHOS_TEST_TARGET&&this.validateModuleName(a,l.getConfigJsonOpt().module.distro.moduleName,common_const_js_1.CommonConst.CONFIG_JSON);const d=project_file_reader_js_1.ProjectFileReader.getJson5Obj(n);validate_util_js_1.ValidateUtil.validateFALiteDevice(d.module.deviceType),validate_util_js_1.ValidateUtil.validateHybridDeviceTypes(d.module.deviceType)}versionCheck(){const e=this.service.getProjectModel(),t=e.getCompileApiVersion();this.moduleModel.getApiType()===hap_extra_info_js_1.ApiType.STAGE&&9>t&&this._log._buildError(`API${t} do not support StageMode.`)._file(e.getProfilePath())._printErrorAndExit()}runtimeOSCheck(e){this.moduleModel.getApiType()===hap_extra_info_js_1.ApiType.STAGE&&e.getTargetStatus().is(runtime_type_enum_js_1.RuntimeTypeEnum.HARMONY_OS)&&this._log._buildError(`HarmonyOS is not supported in stageMode at ${e.getTargetName()} target.`)._file(this.moduleModel.getProfilePath())._printErrorAndExit(this.moduleModel.getName())}validateModuleName(e,t,o){if(e!==t){const i=this.service.getProjectModel().getProfilePath();this._log._buildError(`The name of ${e} module in build-profile.json5 must be same as moduleName in ${o}`)._solution(`Change '${e}' to '${t}'`)._file(i)._printErrorAndExit(t)}}validateHMServiceBundleName(e){var t;const o=null===(t=this.service.getModuleModel())||void 0===t?void 0:t.getSourceRootByTargetName(e),i=path_1.default.resolve(o,common_const_js_1.CommonConst.MODULE_JSON5),s=/\.hmservice$/;if(project_file_reader_js_1.ProjectFileReader.getJson5Obj(i).module.installationFree){const e=this.service.getProjectModel(),t=e.getAppRes().getAppResOpt(),o=e.getAppRes().getJsonPath();if(!s.test(t.app.bundleName)){const e="The value of 'bundleName' in app.json5 is incorrect.",t="If the current OpenHarmony project is an atomized service, the 'bundleName' field in the app.json5 file must end with '.hmservice'.";this._log._buildError(e)._solution(t)._file(o)._printErrorAndExit()}}}validateMainElementAndAbilities(e){var t;const o=null===(t=this.service.getModuleModel())||void 0===t?void 0:t.getSourceRootByTargetName(e),i=path_1.default.resolve(o,common_const_js_1.CommonConst.MODULE_JSON5),s=project_file_reader_js_1.ProjectFileReader.getJson5Obj(i),r=s.module.mainElement;if(s.module.installationFree&&void 0===r){const e="The 'mainElement' field in the module.json5 file does not exist.",t="If the current OpenHarmony project is an atomized service, the 'mainElement' tag must exist.";this._log._buildError(e)._solution(t)._file(i)._printErrorAndExit()}const a=s.module.abilities;null==a||a.forEach((e=>{if(void 0!==r&&e.name===r&&(void 0===e.label||void 0===e.icon)){const e="When the 'mainElement' field is the same as the 'name' field, the 'icon' and 'label' in the 'ability' field cannot be missing.",t="Configuring the 'icon' and 'label' labels in the 'ability' field correctly";this._log._buildError(e)._solution(t)._file(i)._printErrorAndExit()}}))}}exports.PreBuild=PreBuild;