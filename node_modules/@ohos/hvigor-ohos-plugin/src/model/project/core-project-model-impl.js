"use strict";var __createBinding=this&&this.__createBinding||(Object.create?function(e,t,o,i){void 0===i&&(i=o);var r=Object.getOwnPropertyDescriptor(t,o);r&&!("get"in r?!t.__esModule:r.writable||r.configurable)||(r={enumerable:!0,get:function(){return t[o]}}),Object.defineProperty(e,i,r)}:function(e,t,o,i){void 0===i&&(i=o),e[i]=t[o]}),__setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),__importStar=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var o in e)"default"!==o&&Object.prototype.hasOwnProperty.call(e,o)&&__createBinding(t,e,o);return __setModuleDefault(t,e),t},__importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.CoreProjectModelImpl=void 0;const fs=__importStar(require("fs-extra")),path_1=__importDefault(require("path")),common_const_js_1=require("../../const/common-const.js"),module_type_enum_js_1=require("../../enum/module-type-enum.js"),array_util_js_1=require("../../utils/array-util.js"),ohos_logger_js_1=require("../../utils/log/ohos-logger.js"),project_file_reader_js_1=require("../../utils/project-file-reader.js"),validate_util_js_1=require("../../utils/validate-util.js"),legacy_module_model_impl_js_1=require("../module/legacy-module-model-impl.js"),module_model_impl_js_1=require("../module/module-model-impl.js");class CoreProjectModelImpl{constructor(e,t=!1){this.subModels=new Map,this._log=ohos_logger_js_1.OhosLogger.getLogger(CoreProjectModelImpl.name),this.project=e,this.projectPath=e.getNodeDir(),this.name=e.getName(),this._profilePath=path_1.default.resolve(this.projectPath,common_const_js_1.CommonConst.PROFILE_JSON5),this.projectBuildProfileCheck(this._profilePath),this._profileOptions=project_file_reader_js_1.ProjectFileReader.getJson5Obj(this.getProfilePath()),this._productNames=this._profileOptions.app.products.map((e=>e.name)),this.projectStatusCheck(),this.initSubProject(t)}projectStatusCheck(){const e=this.getCompileApiVersion(),t=this.getCompatibleApiVersion();e<8&&this._log._buildError("Only api8 and later are supported for hvigor!")._solution(`Please change compileApiVersion:'${e}'.`)._file(this._profilePath)._printErrorAndExit(this.name),t>e&&this._log._buildError("CompatibleApiVersion can not be larger than compileApiVersion!")._solution(`Please change compileApiVersion: ${e} or compatibleApiVersion: ${t}.`)._file(this._profilePath)._printErrorAndExit(this.name),validate_util_js_1.ValidateUtil.validateDuplicatedName(this._profileOptions.app.products,"products",this._profilePath),validate_util_js_1.ValidateUtil.validateDuplicatedName(this._profileOptions.app.signingConfigs,"signingConfigs",this._profilePath),validate_util_js_1.ValidateUtil.validateDuplicatedName(this._profileOptions.modules,"modules",this._profilePath)}initSubProject(e){this.project.getSubModules().forEach(((t,o)=>{this.subModels.set(o,e?new legacy_module_model_impl_js_1.LegacyModuleModelImpl(t,this):new module_model_impl_js_1.ModuleModelImpl(t,this))}))}getBuildProfileName(){return common_const_js_1.CommonConst.BUILD_FILE_NAME}getName(){return this.name}getPackageJsonPath(){return path_1.default.resolve(this.projectPath,common_const_js_1.CommonConst.PACKAGE_JSON)}getProfilePath(){return this._profilePath}getProjectDir(){return this.projectPath}getProductNames(){return this._productNames}getProfileOpt(){return this._profileOptions}getSubProjects(){return this.subModels}getModuleModelByName(e){return this.subModels.get(e)}getCompileApiVersion(){return this.getProfileOpt().app.compileSdkVersion}getCompatibleApiVersion(){return this.getProfileOpt().app.compatibleSdkVersion}getAllModules(){return[...this.subModels.values()]}getAllEntryModules(){const e=new Set;return this.subModels.forEach(((t,o)=>{t.getModuleType()===module_type_enum_js_1.ModuleType.Entry&&e.add(o)})),e}getTargetApplyProducts(e,t){const o=(0,array_util_js_1.getElementFromArr)(this._profileOptions.modules,e);if(void 0===o)return;const i=(0,array_util_js_1.getElementFromArr)(o.targets,t);return void 0!==i?i.applyToProducts:void 0}getModuleProfileOpt(e){return(0,array_util_js_1.getElementFromArr)(this._profileOptions.modules,e)}projectBuildProfileCheck(e){const t=require("../../../res/schemas/ohos-project-build-profile-schema.json"),o=require("../../../res/schemas/ohos-module-build-profile-schema.json");fs.existsSync(e)||this._log._buildError("Can not find build config file build-profile.json5.")._file(e)._printErrorAndExit(this.name),validate_util_js_1.ValidateUtil.schemaCheckOnly(this.name,e,o)&&this._log._buildError("The build-profile.json5 in project does not meet schema, but meets module's build-profile schema. This may occur when the build-profile.json5 is copied from other modules, or the module's hvigorfile.js requires appTasks instead of hapTasks/harTasks.")._solution("Check the correctness of build-profile.json5 or hvigorfile.js.")._file(path_1.default.resolve(this.projectPath,common_const_js_1.CommonConst.BUILD_FILE_NAME))._printErrorAndExit(this.name),validate_util_js_1.ValidateUtil.doSchemaCheck(this.name,e,t)}}exports.CoreProjectModelImpl=CoreProjectModelImpl;