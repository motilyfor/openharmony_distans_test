"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.LegacyModuleModelImpl=void 0;const array_util_js_1=require("../../utils/array-util.js"),legacy_target_source_set_impl_js_1=require("../source-set/legacy-target-source-set-impl.js"),legacy_ability_model_impl_js_1=require("../ability/legacy-ability-model-impl.js"),module_type_enum_js_1=require("../../enum/module-type-enum.js"),path_1=__importDefault(require("path")),core_module_model_impl_js_1=require("./core-module-model-impl.js"),fs_1=__importDefault(require("fs")),project_file_reader_js_1=require("../../utils/project-file-reader.js"),legacy_form_model_impl_js_1=require("../ability/legacy-form-model-impl.js"),common_const_js_1=require("../../const/common-const.js"),ohos_logger_js_1=require("../../utils/log/ohos-logger.js"),defaultTargetName=common_const_js_1.DefaultTargetConst.DEFAULT_TARGET,ohosTestTargetName=common_const_js_1.DefaultTargetConst.OHOS_TEST_TARGET,_log=ohos_logger_js_1.OhosLogger.getLogger("legacyModuleModel");class LegacyModuleModelImpl extends core_module_model_impl_js_1.CoreModuleModelImpl{constructor(e,t){super(e,t),this.initDefaultTargetSourceSet()}static validateSameNameAbility(e){const t=ohos_logger_js_1.OhosLogger.getLogger("Ability"),o=(0,array_util_js_1.findDuplicateElement)(e.map((e=>e.getName())));o.length>0&&(o.forEach((e=>t.error(`Find duplicated ability name: ${e}`))),t.errorMessageExit("The ability name must be unique. Please check the abilities' name in config.json."))}initDefaultTargetSourceSet(){const e=new legacy_target_source_set_impl_js_1.LegacyTargetSourceSetImpl(path_1.default.resolve(this._sourceRootDir,"main"));this.targetSourceSetMap.set(defaultTargetName,e);const t=new legacy_target_source_set_impl_js_1.LegacyTargetSourceSetImpl(path_1.default.resolve(this._sourceRootDir,"ohosTest"));this.targetSourceSetMap.set(ohosTestTargetName,t)}getLegacyAbilities(e=defaultTargetName){this._legacyAbilitiesMap||(this._legacyAbilitiesMap=new Map,this.initAbilityInfo(defaultTargetName,this.targetSourceSetMap.get(defaultTargetName)),this.initAbilityInfo(ohosTestTargetName,this.targetSourceSetMap.get(ohosTestTargetName)));const t=this._legacyAbilitiesMap.get(e);return void 0===t?this._legacyAbilitiesMap.get("default"):t}getModuleType(e=defaultTargetName){var t,o;const a=this.getSourceSetByTargetName(e),l=null===(o=null===(t=a.getLegacyModuleTargetRes().getConfigJsonOpt().module)||void 0===t?void 0:t.distro)||void 0===o?void 0:o.moduleType;return void 0===l&&_log._buildError("Invalid config.json. Unable to get module type of this module.")._solution("Check the correctness of module/distro/moduleType field of following config.json file:")._file(a.getLegacyModuleTargetRes().getJsonPath())._printErrorAndExit(),module_type_enum_js_1.ModuleType.valueOf(l)}getDeviceTypes(){return this.getSourceSetByTargetName().getLegacyModuleTargetRes().getConfigJsonOpt().module.deviceType}getSourceSetByTargetName(e=defaultTargetName){return this.targetSourceSetMap.has(e)?this.targetSourceSetMap.get(e):this.targetSourceSetMap.get(defaultTargetName)}getJsonObjByTargetName(e){return this.getSourceSetByTargetName(e).getLegacyModuleTargetRes().getConfigJsonOpt()}initAbilityInfo(e,t){const o=t.getLegacyModuleTargetRes().getJsonPath();if(!fs_1.default.existsSync(o))return;const a=project_file_reader_js_1.ProjectFileReader.getJson5Obj(o),l=a.module.abilities?a.module.abilities:[],r=[];for(let e=0;e<l.length;e++)r.push(new legacy_ability_model_impl_js_1.LegacyAbilityModelImpl(o,l[e].name));LegacyModuleModelImpl.validateSameNameAbility(r);const i=a.module.js?a.module.js:[];for(let e=0;e<i.length;e++)"form"===i[e].type&&r.push(new legacy_form_model_impl_js_1.LegacyFormModelImpl(o,i[e]));LegacyModuleModelImpl.validateFormUnique(l),this._legacyAbilitiesMap.set(e,r)}static validateFormUnique(e){const t=ohos_logger_js_1.OhosLogger.getLogger("Form"),o=e.map((e=>e.forms?e.forms.map((e=>e.name)):[])).flat(),a=(0,array_util_js_1.findDuplicateElement)(o);a.length>0&&(a.forEach((e=>t.error(`Find duplicated form name in abilities: ${e}`))),t.errorMessageExit("The form name must be unique in an HAP. Please check the forms' name in config.json."))}}exports.LegacyModuleModelImpl=LegacyModuleModelImpl;